## Symantec Endpoint Protection Local Privilege Escalation

A local privilege escalation vulnerability exists in one of the RPC endpoints exposed by a Symantec Endpoint Protection (SEP) userland service. This can be exploited by unprivileged local users with the ability to execute arbitrary code. An arbitrary file move allows users to create files in System32 which can be exploited to obtain arbitrary code execution under the SYSTEM context.

Exploiting this vulnerability is different under two versions of SEP: 14.0 and 14.2. Under 14.0 all that is required is the execution of the exploit code and a resident DLL on disk. Under 14.2, an additional check is in place in the privileged service that requires the RPC request to originate from a process backed by a Symantec signed binary. This requires code injection. Fortunately, we can simply copy one of the many Symantec signed binaries to a controlled location and DLL hijack ourselves into it.

Please see the blogpost here for a full write-up on the bug.

#### Patch

This bug was disclosed via ZDI by an unknown person and patched in version 14.2.5569.2100 of SEP.

https://support.broadcom.com/security-advisory/security-advisory-detail.html?notificationId=SYMSA1505
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-5825

#### Usage

The included code and IDL was created from SEP version 14.2.5323.2000. Please check your target version prior to deployment. The IPC interface GUID is important and will not work if the version is different. There is another IDL created from a different minor version, 14.2.4815.1101, which can be used. PRs of additional IDL files are welcome!

The GUID is found in the target's registry: ```HKLM\Software\WOW6432Node\Symantec\Symantec Endpoint Protection\{xxxx-yyyy-zzzz}```.

The included code is a C++ project that compiles to a DLL. As previously described, you will need to add the correct IDL to your project. Simply add the version to the project and right click -> Compile. This will generate the necessary header files for interfacing with your version's RPC endpoint. You can add the resulting files (`rpc_c.c`, `rpc_h.h`, and `rpc_s.c`) to your project.

Once you've compiled your DLL, exploiting this against 14.2 needs to be done in the following way:

1. Copy the host executable into a temporary location. The path may vary depending on your victim's exact SEP version:
```
copy "c:\Program Files (x86)\Symantec\Symantec Endpoint Protection\14.2.5323.2000.105\Bin\DevViewer.exe" %localappdata%\DevViewer.exe
```
2. Drop your freshly compiled `RpcDll.dll` into the same path as DevViewer and name it `TextInputFramework.dll`. In case this one doesn't work, some alternatives are `TextShaping.dll` and `devobj.dll` (guaranteed to work, but will break some dependencies so have a copy of `ucrtbased.dll` and `vcruntime140d.dll` nearby).
3. Execute DevViewer

While DevViewer is a GUI application, the payload DLL will `ExitProcess` right after sending the payload. Testing has shown that no GUI is visible to the end user. You should now have your payload in `System32`. All that remains is triggering DiagHub to load the DLL into a privileged context; this can be done using the included `TrigDiag` project.

If you are running against 14.0, you do not need to follow the above steps. Simply change the included code to compile as an executable and run it on the victim machine.
